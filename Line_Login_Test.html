<script type="text/javascript" src="Scripts/liff-edge-2/sdk.js"></script>
Hello
<script type="text/javascript">
    $(function () {
        //document.location.href = "https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=<%=Channel_ID%>&redirect_uri=<%=Callback_URL%>&state=<%=state%>&scope=openid?openExternalBrowser=1";
        
        document.onreadystatechange = subSomething;
    });
    function subSomething() {
        if (document.readyState == "complete") {
			/*
            if (liff.getOS() == "android" && (liff.isInClient() || (navigator.userAgent.indexOf("Line") > -1)) ) {
                document.location.href = "<%=Liff_URL%>";
            }
			*/

			let UToken = Math.random().toString(36).substr(2) + Date.now().toString(36).substr(4);
			
            liff
            .init({ liffId:"<%=Liff_ID%>", })
            .then(() => {
                liff.ready.then(() => {
                    let _context = liff.getContext();
                    if (_context.userId) {
						if (liff.getOS() == "android" && (liff.isInClient() || (navigator.userAgent.indexOf("Line") > -1)) ) {
							Submit_external( UToken, _context.userId );
						}
						else{ 
							Submit(_context.userId);
						}
                    }
                    else {
                        liff.login();
                    }
                    //console.log(_context);
                    //console.log('1');
                    //liff.login({});
                });
            })
            .catch((err) => {
                console.log(err.code, err.message);
            });
        }
    }
    function Submit(userId) {
        var form = document.createElement("form");
        form.method = "POST";
        form.action = "/sp-lineMember-login-1.html";

        var element = document.createElement("input");
        element.type = "hidden";
        element.value = userId;
        element.name = "userId";
        form.appendChild(element);

        document.body.appendChild(form);
        form.submit();
    }
	
	function Submit_external(uToken, uID) {
		let formData = new FormData();
		formData.append("action", "InsertUIDMapping" );
		formData.append("uToken", uToken );
		formData.append("uID", uID);
		
		fetch("/sp-opre-service-1.html", {
			method: "POST",
			body: formData
		}).then((response) => {
			return response.json();
		}).then((jsonData) => {
			//console.log(jsonData);
			//alert(JSON.stringify(jsonData));
			
			liff.openWindow({
				url: "<%=Callback_URL%>?uToken=" + uToken,
				external: true
			})
			//document.location.href = "<%=Callback_URL%>?uToken=" + uToken ;
		});
	}
	

</script>
